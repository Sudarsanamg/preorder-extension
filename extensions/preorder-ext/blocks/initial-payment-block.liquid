{% assign deposit_percent = product.metafields.custom.deposit_percent.value | default: 0 %}
{% assign product_price = product.price | money_without_currency %}
{% assign units_sold = product.metafields.custom.preorder_units_sold %}
{% assign max_units  = product.metafields.custom.preorder_units %}

{% if deposit_percent > 0 %}
  {% assign initial_payment = product_price | times: deposit_percent | divided_by: 100 %}
  {% assign balance_payment = product_price | minus: initial_payment %}
  {% assign balance_due_date = product.metafields.custom.balance_due_date.value %}

  <div class="preorder-payment-info">
    <p>
      Pay ₹{{ initial_payment | round }} now and ₹{{ balance_payment | round }} on {{ balance_due_date | date: "%d %b %Y" }}
    </p>
  </div>

  
{% endif %}


{% if units_sold >= max_units %}
  <div id="sold-out">
    <p>Out of stock</p>
   
</div>
{% endif %}


<script>
  document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    const buyNowBtn = document.querySelector("shopify-buy-it-now-button button");
    const addToCartBtn = document.querySelector("form[action*='/cart/add'] [type='submit']");

    const max_units = {{ product.metafields.custom.preorder_units.value | default: 0 | json }};
    const units_sold = {{ product.metafields.custom.preorder_units_sold.value | default: 0 | json }};

    if (units_sold >= max_units && max_units > 0) {
      if (buyNowBtn) {
        buyNowBtn.disabled = true;
        buyNowBtn.textContent = "Sold Out";
        buyNowBtn.classList.add("disabled");
      }
      if (addToCartBtn) {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = "Sold Out";
        addToCartBtn.classList.add("disabled");
      }

      const soldOutMsg = document.getElementById("sold-out");
      if (soldOutMsg) soldOutMsg.style.display = "block";
    }
  }, 500); 
});

</script>
{% schema %}
{
  "name": "initial payments block",
  "target": "section",
  "settings": []
}
{% endschema %}
